# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|

 config.vm.define "master" do |subconfig|
   subconfig.vm.box = "debian/buster64"
   subconfig.vm.hostname = "master"
   config.disksize.size = '100GB'
   subconfig.vm.network "private_network", ip: "192.168.33.10"

   subconfig.vm.provision "shell", inline: <<-SHELL
     sudo curl -fsSL -o /usr/share/keyrings/salt-archive-keyring.gpg https://repo.saltproject.io/salt/py3/debian/10/amd64/latest/salt-archive-keyring.gpg

     echo "deb [signed-by=/usr/share/keyrings/salt-archive-keyring.gpg arch=amd64] https://repo.saltproject.io/salt/py3/debian/10/amd64/latest buster main" | sudo tee /etc/apt/sources.list.d/salt.list

     apt-get update
     apt-get install salt-master -y 
     apt-get install salt-ssh -y
     apt-get install salt-api -y
   SHELL
 end

 config.vm.provider "virtualbox" do |vb|
   vb.memory = 2048
   vb.cpus = 2
 end


  (1..2).each do |i|
    config.vm.define "minion#{i}" do |subconfig|
      subconfig.vm.box = "debian/buster64"
      subconfig.vm.hostname = "minion#{i}"
      subconfig.vm.network "private_network", ip: "192.168.33.1#{i}"
      subconfig.vm.provision "shell", inline: <<-SHELL
        sudo curl -fsSL -o /usr/share/keyrings/salt-archive-keyring.gpg https://repo.saltproject.io/salt/py3/debian/10/amd64/latest/salt-archive-keyring.gpg

        echo "deb [signed-by=/usr/share/keyrings/salt-archive-keyring.gpg arch=amd64] https://repo.saltproject.io/salt/py3/debian/10/amd64/latest buster main" | sudo tee /etc/apt/sources.list.d/salt.list

        apt-get update
        apt-get install salt-minion -y
        apt-get install salt-ssh -y
        apt-get install salt-api
     SHELL
    end

    config.vm.provider "virtualbox" do |vb|
      vb.memory = 2048
      vb.cpus = 2
    end
  end


 # config.vm.provision "shell", inline: <<-SHELL
  #   apt-get update
  #   apt-get install -y apache2
  # SHELL
end
